-- Створюємо CTE з денними метриками
WITH daily_metrics AS (
    SELECT
        ss.date AS order_date,                             -- дата замовлення
        FORMAT_DATE('%d %B', ss.date) AS Date,             -- дата у форматі "день + місяць"
        ROUND(SUM(pro.price)) AS total_revenue,            -- денний дохід
        COUNT(DISTINCT id) AS count_orders,            -- кількість замовлень (унікальні id замовлень)
        COUNT(DISTINCT ac.id) AS count_clients,            -- кількість клієнтів (унікальні акаунти)
        ROUND(AVG(pro.price)) AS avg_check                 -- середній чек
    FROM `data-analytics-mate.DA.order` AS ord
    INNER JOIN `data-analytics-mate.DA.product` AS pro
        ON ord.item_id = pro.item_id                       -- зв'язок замовлень із товарами
    INNER JOIN `data-analytics-mate.DA.session` AS ss
        ON ord.ga_session_id = ss.ga_session_id            -- додаємо сесії
    INNER JOIN `data-analytics-mate.DA.account_session` AS ass
        ON ord.ga_session_id = ass.ga_session_id           -- зв'язуємо сесію з акаунтом
    LEFT JOIN `data-analytics-mate.DA.account` AS ac
        ON ass.account_id = ac.id                          -- акаунти: LEFT JOIN, щоб не загубити користувачів
    GROUP BY ss.date                                       -- агрегуємо по датах
)

-- Фінальний вибір метрик + віконна функція для % приросту доходу
SELECT
    Date,
    total_revenue,
    count_orders,
    count_clients,
    avg_check,
    
    -- % зміна доходу відносно попереднього дня
    ROUND(
        (total_revenue - LAG(total_revenue) OVER (ORDER BY order_date)) 
        / LAG(total_revenue) OVER (ORDER BY order_date) * 100, 2
    ) AS revenue_growth_pct
FROM daily_metrics
ORDER BY order_date;   -- сортуємо за датою
